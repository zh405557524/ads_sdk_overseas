---
description: Bug修复任务规则 - lib（SDK）与 example（Demo）分别约定
globs: 
alwaysApply: false
---

# Bug修复任务规则

修复前先明确**改动范围**：本次修复在 **lib（SDK）** 还是 **example（Demo）**，再按对应规范执行（见 `01-项目结构说明.mdc`）。

---

## 修复流程

### 1. 问题定位

- **必须**先阅读相关代码，理解问题发生的上下文
- 查看错误日志、异常信息（如果有）
- 检查相关的测试用例或用户反馈
- 使用 `grep` 或 codebase 搜索查找相关代码

### 2. 根本原因分析

- 不要只修复表面症状，要找到根本原因
- 分析为什么会出现这个问题
- 考虑是否有其他类似的问题

### 3. 修复原则

- **最小化修改**：只修改必要的代码，避免引入新的问题
- **保持一致性**：修复方式要与项目现有代码风格一致
- **向后兼容**：确保修复不会破坏现有功能
- **添加防护**：在关键位置添加必要的错误检查和边界条件处理

### 4. 错误处理

- 添加适当的 try-catch 块
- 记录错误日志（使用 logger 或 debugPrint）
- 向用户/调用方展示友好的错误提示或返回值
- 避免静默失败

### 5. 测试验证

- 验证修复是否解决了问题
- 检查是否引入了新的问题
- 考虑边界情况和异常情况

---

## 按改动范围的规范

### lib（SDK）修复时

- **不破坏现有公共 API 行为**：修改参数、返回值、异常类型时需考虑调用方兼容性
- **Platform Interface / Method Channel**：重点检查平台层异常、空值、超时等边界条件；异常需转为对调用方友好的错误或返回值（见 `06-编码规范.mdc`）
- **单元测试**：若项目 `test/` 下有相关用例，修复后补充或更新测试；新增逻辑建议加测试

### example（Demo）修复时

- 修复 Demo 行为、依赖或集成方式即可
- **仅当修改 example 时**适用以下内容：
  - **GetX Controller**：确保正确使用 `update()` 通知 UI 更新；在 `onClose()` 中正确释放资源；处理异步操作的错误情况
  - **API/网络调用**：添加网络错误处理、超时、返回数据有效性校验
  - **状态管理**：确保状态更新的原子性，避免竞态，正确处理异步状态更新

---

## 检查清单

修复完成后，检查以下项目：

- [ ] 问题已完全解决
- [ ] 没有引入新的 bug
- [ ] 代码符合项目规范（lib 见 SDK 规范，example 见 Demo 规范）
- [ ] 错误处理已添加
- [ ] 资源已正确释放（如需要）
- [ ] 日志记录已添加（如需要）
- [ ] 用户/调用方提示或返回值已处理（如需要）
- [ ] **若修改 lib**：公共 API 行为未破坏，平台异常已妥善转换；必要时已补充/更新 `test/` 下用例

---

## 示例修复模式

### 空指针检查

```dart
// ❌ 错误
String name = user.name;

// ✅ 正确
String name = user?.name ?? '';
```

### 异步错误处理（lib 或 example）

```dart
// ❌ 错误
final result = await api.getData();

// ✅ 正确
try {
  final result = await api.getData();
  // 处理结果
} catch (e) {
  logger.e('获取数据失败', error: e);
  // lib：可 rethrow 或返回 Result/Nullable；example：可 Toast 提示
}
```

### Controller 资源释放（仅 example 使用 GetX 时）

```dart
@override
void onClose() {
  textController.dispose(); // ✅ 确保释放资源
  super.onClose();
}
```
